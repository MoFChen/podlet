name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - run: cargo fmt --verbose --check

  clippy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - run: cargo clippy -- -Dwarnings

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - run: cargo test --verbose

  build-container:
    runs-on: ubuntu-latest
    container:
      image: quay.io/containers/buildah:latest
      options: --security-opt seccomp=unconfined --security-opt apparmor=unconfined --device /dev/fuse:rw
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - run: buildah version

      - name: Build ARM image
        run: buildah build --platform linux/arm64/v8 -t podlet .

      - name: Build x86 image
        run: buildah build --platform linux/amd64 -t podlet .
